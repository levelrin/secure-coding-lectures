# Improper Session Management

We will discuss how a website can be hacked due to improper session management.

### Prerequisite

To follow this document, we need to install the following:
1. [Docker](https://docs.docker.com/get-docker/)

### Setup

Let's build a Docker image that contains the necessary environment.
Please open the terminal and go to the directory where this file exists.
And we can build the image like this:
```
docker build -t improper-session-management:1 .
```

After building the image, let's run the container like this:
```
docker run --rm --name improper-session-management -v ${PWD}:/usr/share/improper-session-management -p 5000:5000 -it improper-session-management:1 /bin/bash
```
We should be in the container's shell.

Let's go to the directory where the source code for the web application exists:
```
cd /usr/share/improper-session-management
```

We are ready to discuss the improper session management.

### Attack

We can run the web application like this:
```
export FLASK_APP=bad
flask run --host 0.0.0.0
```

We can access the web application via `http://localhost:5000`.
Note, there is a `session_id` query parameter in the URL.
Once you log in, that session_id will be activated, and you will be able to see the user information.
You can check the credentials in the `bad.py` file.
Let's log in using the following credentials:
 - ID: test01
 - Password: 1111

You will see the user information as long as you use that session_id.
Let's open the new tab and access the web application again via http://localhost:5000.
Please pay attention to the new session_id.
Let's log in using the following credentials:
 - ID: test02
 - Password: 2222

The next session_id has been activated for test02.
You can do the same thing with another user credential.

At this point, you will figure out that the new session_id is generated by incrementing the number of the previous session_id by 1.
There are many ways to hack this online shopping center.

One way is to simply guess the active session_id.
In this case, the hacker can try session_id starting from 0 and incrementing it by 1.
The hacker will eventually find the active session_id.
This approach is called `Guessing Session ID` attack.

There is another approach called `Stealing Session ID` attack.
A hacker can set up a trap so that the user give their session_id to the hacker.
Or, the hacker can get it by sniffing the network.

There is another approach called `Session Fixation` attack.
It's about giving a session_id (it's not activated yet) to the user and let them log in using that session_id.
Once the user logs in, the session_id is activated, which is known to the hacker.
Here is an example:
```
Hacker: Hey, what items do you have? Here is the link: http://localhost:5000?session_id=0
Victim: Let me check.
(Clicks the link and log in)
Victim: I have apple and banana.
Hacker: Oh, I see. Thanks!
(At this point, the hacker has the session_id of the victim.)
```

### Secure Coding

There is another web application file called `good.py`.
It's the same as the `bad.py` except the code is written securely.
Please check the code written in the `good.py` to see the solution.

Let's confirm if the website is no longer vulnerable.
Please go to the container's shell and press `Ctrl + C` on your keyboard to stop the vulnerable website.
Next, let's run the secure website by executing the following commands:
```
export FLASK_APP=good
flask run --host 0.0.0.0
```

Once again, we can access the website from the host machine at `http://localhost:5000/`.

The website is more secure because:
1. The session ID is difficult to guess.
2. It does not use URL parameter to store the session ID.

### Close

We are done with studying the improper session management.

We can use' exit' commend to close the container's shell.
Furthermore, we no longer need the `improper-session-management:1` image. Let's delete it by the following command:
```
docker rmi improper-session-management:1
```

That's it. Thank you for reading this document :)
